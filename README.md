
# NADO (나의 도시를 찾아서)
### 협업 도구
---
###### Jira , Confluence
https://jiwonkim.atlassian.net/jira/software/projects/CAPSTONE/boards/1
<br>

### 기술 스택
---


#### Back-End
+ Java 11
+ Spring Boot 2.7.11
+ Gradle
+ Spring Data JPA
+ Spring Security
+ linux
+ Postman
+ MySQL 8.0
+ Chat GPT


### Front-End
+ TypeScript
+ React.js

  <br>

### 주요 개발
---
<b>1)	전체 시스템 아키텍쳐 및 프로세스</b>
<br>

![image](https://github.com/capstone-team02/readme/assets/78153919/beb15818-58d5-466b-b114-af98dc6be784)

<br>
&nbsp; 해당 서비스는 실제 웹서비스를 사용하는 <b>‘사용자’</b>, 사용자의 요청을 받아 처리하는 <b>‘시스템’</b>, 데이터 적재를 하는 <b>‘서비스 주체'</b>, 그리고  <b>‘데이터베이스’</b>  네가지  주요  구성 요소로 이루어져 있다.
<br>
<br>
① 회원 시스템은 회원 가입, JWT 를 통한 로그인과 로그아웃, 회원 탈퇴, 회원 수정 프로세스를 수행한다.
<br>
<br>
② 설문조사 시스템은 설문조사 답변 및 chat GPT 를 거친 리뷰 저장, 설문조사 답변 조회, 리뷰 조회의 프로세스가 수행된다.
<br>
<br>
③ 검색 시스템은 동네 테이블을 중심으로 이루어진다. 기본  데이터  적재와  동네별  점수 부여 계산 프로세스가 기본적으로 이루어진 후 메인 페이지에서의 동네 추천, 추천  동네 검색을 위한 조회, 동네별 정보조회 프로세스가 수행된다.
<br>
<br>
④ 챗봇 시스템은 chatGPT 와 채팅 기록 저장, 채팅 기록 조회 프로세스가 수행된다.
<br>
<br>
<br>
  
<b>2) 인터페이스</b>


&nbsp; 서비스의 주요 인터페이스를 다이어그램과 함께 설명한다.


① 설문조사 진행 및 저장


   ![image](https://github.com/capstone-team02/readme/assets/78153919/a2353589-bf10-417b-a2b1-9011541d0cb7)



사용자가 회원가입을 완료하면 해당 정보가 유저 테이블에 저장된다. 이후 설문조사에 답변을 하면 해당 답변은 설문조서 DTO 에 우선적으로 저장된다. 이 저장된 답변들로부터 후처리를 거친 후 chat GPT 에게 리뷰 생성을  요청하고,  응답을  받는다면  해당  리뷰와  함께 설문조사 답변 정보들이 최종적으로 설문조사 테이블에 저장된다.


② open API 데이터와 .csv 파일 데이터 적재


![image](https://github.com/capstone-team02/readme/assets/78153919/d1361b9e-eb5d-412b-992c-238d076482a8)


데이터 적재 요청을 하면 미리 준비된 .csv 파일로부터 구, 동, 인구정보, 시설정보 테이블에 데이터가 적재된다. 이후 open API 링크를 통해 부동산 정보가 부동산 테이블에 적재된다.

③ 동네별 순위 부여

![image](https://github.com/capstone-team02/readme/assets/78153919/086eacd5-8045-448c-8b7c-42b104ec38c7)


동네별 순위 계산 요청으로부터 동네의 인구 수 및 밀집도 데이터와  시설의  데이터에 따라 score 테이블에 동네별로 저장이 된다.


 ④ 동네 검색 결과

![image](https://github.com/capstone-team02/readme/assets/78153919/7832345a-80a1-4c25-8f82-82a2675e17da)


Client 단에서 사용자는 원하는 조건을 선택한 후 동네를 검색한다. 해당 조건을 바탕으로   동 테이블에서 조건에 적합한 동네를 찾고 해당 동네는 검색 결과로 보인다. 결과 창에서 동네의 핵심 키워드, 장단점, 리뷰와 부동산 정보를 보여주기 위해 결과에 해당하는 동네의 정보를 조회하여 다시 Client 로 응답을 보낸다.


### 주요 개발
---
1)	chatGPT API 를 활용한 동네 리뷰

   
   ![image](https://github.com/capstone-team02/readme/assets/78153919/8657264f-ee3c-47fa-8e06-61e5c04f9c76)
  	
&nbsp; chatGPT 로부터 데이터를 얻기위한 요청과 응답은 상단의 그림과 같다. 프롬프트는 단어들을 주어주고 리뷰를 생성하라는  요청으로  보냈다.  기대하는  형태의  답변(응답)을 위해 몇 번의 테스트를 거치며 프롬프트 구성에 다음과 같은 점들을 신경썼다.

&nbsp; chatGPT 의 특성상 말을 지어내는 것에 집중하여 테스트 시에 응답 답변의 길이가 몹시 길었다. 따라서 180byte 이내로  답변할  것을  요구했다.  그  후  답변의  맥락이  자연스러울 수 있도록 설문조사 시의 단어를  그대로  사용하지  않고  후처리를  거쳐  보냈다.  또한 영어로 질문을 한 뒤 한국어로 답변해달라는 조건을 붙일 시 그렇지 않을 때보다 더 자연스러웠다.

![image](https://github.com/capstone-team02/readme/assets/78153919/7dfccb5f-d73e-440c-b3ac-efc5ea3bb48c)
![image](https://github.com/capstone-team02/readme/assets/78153919/13b1339d-0a50-4720-aadb-e7682c032e6d)



2) 검색 기능에 따른 동네 순위

   
&nbsp;   검색 기능은 사용자가 원하는 조건에 따른 ‘맞춤’ 검색이 핵심이다. 이를 위해 사용자가 선택한 조건 카테고리마다 점수를 더한 후 최종적으로 낮은 순위(상위 순위) 값을 가지는 동네를 결과로 내는 방식으로 구현했다.
 
&nbsp; 검색 조건(카테고리)에 따라 csv 로부터 가져온 데이터들을 활용했다. 우선 카테고리는
10 대가 많은, 20 대가 많은 등의 나이별 카테고리, 병원, 약국, 교육기관 등 시설별 카테고리들이 존재한다. 이 카테고리 별로 순위를 저장할 수  있는  순위 DB  를  정의한다.  예를 들어 식당이 많은 동네는 높은 점수를 가지도록 하는 로직을 구성했는데,  점수가 높을수록 높은 순위로 간주하며 해당 순위 DB 는 각 동네마다 계산하여 저장한다. 이렇게 계산된 순위 DB 를 통해 사용자가 검색을 할 때 그  조건을  충족하는  높은  순위를  가진 동네가 결과로 나오게 되는 것이다.


### 문제점 및 해결 방안
---

1)	부동산 데이터 적재: .CSV 파일 사용과 OpenAPI 형식 사용 중 선택
CSV 파일은 적재 속도가 빠르지만, 파일을 매번 다운로드 해야한다는 문제점이 있고, OpenAPI 형식은 적재 속도는 느리지만, 스케줄링으로 업로드 시기를 설정할 수  있다는  장점이 있다. 부동산은 계속 변화하는 데이터 이므로 OpenAPI 형식을 채택하게 되었다.


2)	JPA 를 통한 수정
JPA 는 set()를 사용하여 수정을 하면 저절로 수정 쿼리가 실행이 된다(Dirty Checking). 그러나 그러나 막상 수정 기능을 setter 만 사용하니 테스트 시에 기타 에러가 발생하지 않음에도 불구하고 실제로 DB 에는 update 반영이 제대로 되지 않는 문제가 발생했다.
이를 해결하기 위해 테이블을 생성할 떄와 마찬가지로  Repository  의  .save()를  쓰는  것이 옳은 방법이다. JPA 는 sava()를 사용할 시, 내부적으로 @ID 값을 비교하여 생성 혹은 수정 쿼리를 실행한다. 이미 @ID 가 존재하므로 수정 의도를 가지고 .save()를 사용할 시   수정 내용이 실제 DB 에 정상적으로 반영되는 것이다. 더불어 setter 메소드를 사용할 시 외부로부터 값이 오염될 수 있는 가능성도 방지할 수 있다.
 

3)	Optional<Entity>와 Entity

![image](https://github.com/capstone-team02/readme/assets/78153919/1464e49e-cd9e-4c3f-96f9-74f4cccda63d)

사용자의 엔티티를 찾기 위해 SecurityUtil.getCurrentMemberId()를 통해 Optional<UserENtity> findById() 메소드를 사용했다. 결과값인 Optional 안에  실제로 사용할 사용자 엔티티를 꺼내기 위해서는 .get() 메소드를 사용해야 하는데, 문제는 이 때 엔티티의 반환 값이 null 로 뜬다는 것이다. Id 값을 넣어 사용하거나 다른 Entity 의 .getId() 값을	넣어	사용할	때는	정상적으로	.get()값이	반환이	됐지만	SecurityUtil. getCurrentMemberId()를 사용할 떄에는 그렇지 않았다. 원인은 알 수 없었지만 반환값이 userEntity 그 자체인 메소드가 필요했다.
findById()는 이미 사용하고 있는 클래스가 존재해 삭제하거나  반환값을  수정할  수 없었고, 결론적으로 find 와 유사한 findAll 을 생성하기로 했다. 사용자의 id 값은 하나만 존재하는 컬럼 속성이므로 여러 값을 불러오게 될 여지도 없다고 판단했다.

![image](https://github.com/capstone-team02/readme/assets/78153919/e740da1a-b151-4d6d-8708-c061a92c5df0)

finAllById()는 userEntity 를 null 값이 아니라 정상적으로 사용 가능

4)	리액트 실행 환경
window wsl 환경에서 우분투로 실행을 할 경우, C 드라이브에 저장하면 권한  설정이 어렵고, 실행 속도도 매우 느리기 때문에, wsl 의 home directory 에 환경을 만들어 주는  것이 가장 옳은 방법이다.
또한 코드를 작성할 때는 wsl 경로로 타고 들어가 code . 명령어를 치게 되면 vscode 가 자동으로 열린다.
 
5)	프론트엔드 작업 상에서의 설문 조사에서 구/동을 선택하는 dropdown
해당 기능은 구에 맞는 동을 선택해야 하므로 key 값이 필요하다는  조건이  있다.  이  조건을 충족하기 위해서
구 1 [동 1, 동 2, 동 3, 동 4 .●●●  ]
구 2 [동 1, 동 2, 동 3, 동 4 .●●●  ]
의 형식으로 API 를 수정하고 key 값을 guSelect 변수를 만들어 useState()를  사용해서 설정할 수 있도록 하였다.

6)	GCP 배포


-	시도 1
: cloud shell 환경에서 git clone 을 하고, ./gradlew clean bootRun 명령어를 실행하는 방법을 사용해보았지만 이 환경에서만 실행되고 google authentication 정보가 포함되지 않아서 루트가 막혔다.


-	시도 2
: intelliJ 에서 직접 jar 파일을 만들어 가상 ssh 에서 upload 한 뒤 실행하는 방법을 사용했을 떄 main class 파일이 읽히지 않는 오류가 발생했다. ssh 환경에서도 마찬가지로 main class 파일이 읽히지 않는 오류가 발생했다.


-	시도 3 및 최종 솔루션
: intellij 나 vscode 에서 파일 경로로 접속한 뒤, ubuntu 환경에서 gcloud init 을 해준다. 현재 로그인 하고 있는 계정을 선택하고, (이 때 반드시 credit  이  있어야한다)  프로젝트를  선택한 뒤, 환경을 선택해준다. 이후, gcloud  app  deploy  명령어를  입력해  배포한다. 주의할 점은 현재 파일 경로가 맞는지 확인해야한다.  여기서  gradlew  에  대한  오류가 다음과 같이 발생한다.


 	E: “./gradlew" is a script, ensure that it has Unix-style LF line endings	

해당 오류의 해결방법은 gradlew 파일 맨 끝에 :set  fileformat=unix  을 추가해주는 것이다.
Deploy service to~ (이하생략) 부분에 나와있는 link 가 host IP 가 되는 것이다. 이후에 백에서 설정해둔 CORS 에러의 allow origin 부분에 이  링크를  추가해주면  된다. (*  사진  하단 첨부)
 
![image](https://github.com/capstone-team02/readme/assets/78153919/621d1f99-9ad6-42ea-9237-aa6d4ea2429e)

[gcloud init]

![image](https://github.com/capstone-team02/readme/assets/78153919/a734fc07-4522-4b64-a8a1-51decc978387)


### Lessons Learned
---


김지원) 예전에 spring boot 로 개발을 했을 때 , 프론트엔드에 어떻게 데이터를 전송해야하는지 고민이 많이 됐었는데, 직접 프론트와 백을 동시에 구현하면서  어떤  방법이 최선의 방법인지 생각해보게 되는 계기가 되었다. 리액트에서 데이터를 유지하는 방법이나 라우팅 하는 방법들을  새로  공부하면서  궁금했던  프론트  작업을  공부할  수 있어서 좋았다. 전에 html css javascript 로 간단히 한  것  보다  component  들이  잘  나뉘어 있어서 개발하기 더 편리 했던 것 같다. 리액트와  스프링  부트  서버를  동시에 배포하는 건 성공시키지 못했지만, gcp 에서 배포하는 방법을 여러개 찾다가  gcp  app  deploy 를 사용하게 됐는데, 생각보다 간편해서 배포하는 방법을 하나 얻을 수 있어서 좋다. 팀원과 둘이서 진행을 하느라 두명 다 너무 고생했지만 짧은  시간  내에  생각보다  새로  알아간 내용도 많고 구현도 어느정도 된 것 같아서 보람차다.

김민채) Spring boot 로 반드시 프로젝트를 해보고 싶었는데 이번이 마침 좋은 기회였다. 관련된 라이브러리들과 구조 등 새로 알아야하는 개념들에  관해  많은  공부가  되었다.  특히나 팀원 수와 관련하여 조정을 하다가 새로운 팀원 분을 들었는데,  다행히 spring boot 경험이 있으셔서 새로운 언어임에도 불구하고 비교적 편하게 따라갈  수 있었다. 새로운 개념과 구조들을 익히는데에 어려움이 완전히 없었다고는 할  수  없지만  오히려 모르기 때문에 열심히 습득하는 자세를 가질 수 있었다. DTO 와 ENTITY 의 차이 및 구분 이유, Contorller 와 Service 계층간 역할 등 프로젝트를 진행하면서 개인적으로 흥미로운 의문이 드는 부분들도 노션에 저이하며 공부를 했다.  특히나  쿼리를  사용하지  않고도  CRUD 를 편하게 사용할 수 있는 JPA 를 다루어본 점이 가장 인상깊게 남는다. 최근 트렌드 기술이 Chat 혰를 활용해볼 수 있는 점도 재밌었다. API 를 다루는 정보가 생각보다 많지 않았지만 다행히 사용법이 어렵지 않았고, API 를 가져오는 부분보다는 프롬프트를 어떻게 가공해서 요청을 보낼지에 대해 더욱 신경을 쓰게 됐다. 애자일 기법을 처음으로 활용하면서 지라를 사용해볼 기회도 있었던 것이 유익하게 남는다. 다만 익숙하지  않은  상태로 처음으로 진행해보는 기법이라 초반에 아쉬운 점으로 남는게 있는데, 바로 테이블 설계를 완전히 마치지 않은 채 다음 스프린트로  넘어가기  급급했던  부분이다.  테이블  설계를 명확히 하는 것이 개발 도중의 잦은 수정 및 혼란을 막을 수 있다는 점을 다시한번 깨달았다.

 

